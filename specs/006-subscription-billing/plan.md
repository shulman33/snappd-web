# Implementation Plan: Subscription Billing and Payment Management

**Branch**: `006-subscription-billing` | **Date**: 2025-11-05 | **Spec**: [spec.md](./spec.md)

## Summary

Comprehensive subscription billing system powered by Stripe with three plan tiers (Free, Pro $9/month, Team $9/user/month). Supports 14-day free trials with automatic conversion, multi-seat team billing with proration, usage-based quota enforcement, payment failure recovery with Smart Retries, and complete subscription lifecycle management. System integrates Stripe Checkout for payment collection, Customer Portal for self-service billing, and webhook processing for real-time plan enforcement. All billing operations logged with full audit trail and email notifications at each lifecycle stage.

**Key Technical Decisions**:
- **Payment Processor**: Stripe (industry standard, PCI compliant)
- **Architecture**: Next.js API routes + Stripe webhooks + Supabase PostgreSQL
- **Trial Strategy**: 14-day with payment method required (60%+ conversion rate)
- **Proration**: Automatic via Stripe (handles all edge cases)
- **Dunning**: Smart Retries (70% recovery rate) + 4-stage email campaign
- **Tax**: Stripe Tax (automatic compliance for all jurisdictions)

## Technical Context

**Language/Version**: TypeScript 5.x with Next.js 15.5.5 (App Router), React 19.1.0
**Primary Dependencies**:
- `stripe` (v16.x) - Stripe Node.js SDK for subscription management
- `@supabase/supabase-js` (v2.78+) - Database and authentication
- `@sendgrid/mail` (v8.1+) - Email delivery for billing notifications
- `zod` (v4.1+) - Request validation and type safety

**Storage**: Supabase PostgreSQL 17+ with RLS policies for multi-tenant billing data
**Target Platform**: Vercel Edge Runtime for API routes, PostgreSQL for billing metadata
**Project Type**: Web application (Next.js App Router)
**Performance Goals**:
- Checkout session creation: <500ms p95
- Webhook processing: <2s p95 (10s timeout)
- Quota check: <100ms p95 (cached subscription status)
- Invoice generation: <5s p95

**Constraints**:
- PCI DSS compliance via Stripe (no card data storage)
- HTTPS only for all billing endpoints
- Webhook idempotency (25%+ events are retries)
- Rate limiting: 10 payment attempts/hour per user
- Grace period: 14 days for payment failure recovery

**Scale/Scope**:
- Expected: 10K active subscriptions, 1K new signups/month
- Webhook volume: 50K events/month
- Invoice volume: 10K invoices/month
- Team subscriptions: ~20% of paid users (2K teams)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Speed as Core Value âœ…
- **Checkout flow**: <3s to create session, redirect to Stripe Checkout
- **Quota checks**: <100ms via cached subscription status (Redis)
- **Plan upgrades**: Immediate access (<60s from payment to feature unlock)
- **Performance monitoring**: Track all billing API response times

**Measurement**: Datadog APM tracking p50/p95/p99 for all billing endpoints

### Freemium Conversion Focus âœ…
- **Free tier**: 10 uploads/month (enough to demonstrate value)
- **14-day trial**: Removes friction, allows premium features
- **Team plans**: Clear value prop for organizations (consolidated billing, admin controls)
- **Target**: 5-10% free-to-paid conversion rate

### Library-First Approach âœ…
- `src/lib/billing/stripe.ts` - Stripe client initialization
- `src/lib/billing/subscription.ts` - Subscription CRUD operations
- `src/lib/billing/quota.ts` - Usage tracking and enforcement
- `src/lib/billing/team.ts` - Team management logic
- `src/lib/billing/webhook.ts` - Webhook processing utilities
- `src/lib/billing/proration.ts` - Proration calculation helpers
- `src/lib/billing/dunning.ts` - Payment failure recovery logic

**Rationale**: Billing logic reused across API routes, webhooks, and background jobs

## Project Structure

### Documentation (this feature)

```text
specs/006-subscription-billing/
â”œâ”€â”€ plan.md              # This file
â”œâ”€â”€ research.md          # Stripe API best practices (Phase 0 complete)
â”œâ”€â”€ data-model.md        # Database schema (Phase 1 complete)
â”œâ”€â”€ quickstart.md        # Developer setup guide (Phase 1 complete)
â”œâ”€â”€ contracts/           # API contracts (Phase 1 complete)
â”‚   â””â”€â”€ billing-api.yaml # OpenAPI 3.1 spec
â”œâ”€â”€ checklists/
â”‚   â””â”€â”€ requirements.md  # Spec quality validation (complete)
â””â”€â”€ tasks.md             # Implementation tasks (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
# Next.js App Router Structure (Web Application)

src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ v1/
â”‚   â”‚       â””â”€â”€ billing/              # Billing API routes (NEW)
â”‚   â”‚           â”œâ”€â”€ create-checkout/
â”‚   â”‚           â”‚   â””â”€â”€ route.ts      # POST: Create Stripe Checkout session
â”‚   â”‚           â”œâ”€â”€ create-portal/
â”‚   â”‚           â”‚   â””â”€â”€ route.ts      # POST: Create Customer Portal session
â”‚   â”‚           â”œâ”€â”€ subscription/
â”‚   â”‚           â”‚   â”œâ”€â”€ route.ts      # GET: Get current subscription
â”‚   â”‚           â”‚   â”œâ”€â”€ cancel/
â”‚   â”‚           â”‚   â”‚   â””â”€â”€ route.ts  # POST: Cancel subscription
â”‚   â”‚           â”‚   â””â”€â”€ reactivate/
â”‚   â”‚           â”‚       â””â”€â”€ route.ts  # POST: Reactivate subscription
â”‚   â”‚           â”œâ”€â”€ usage/
â”‚   â”‚           â”‚   â”œâ”€â”€ route.ts      # GET: Get usage and quotas
â”‚   â”‚           â”‚   â””â”€â”€ check/
â”‚   â”‚           â”‚       â””â”€â”€ route.ts  # POST: Check upload quota
â”‚   â”‚           â”œâ”€â”€ teams/
â”‚   â”‚           â”‚   â”œâ”€â”€ route.ts      # POST: Create team
â”‚   â”‚           â”‚   â”œâ”€â”€ [teamId]/
â”‚   â”‚           â”‚   â”‚   â”œâ”€â”€ route.ts  # GET/PATCH: Team details
â”‚   â”‚           â”‚   â”‚   â””â”€â”€ members/
â”‚   â”‚           â”‚   â”‚       â”œâ”€â”€ route.ts         # POST: Invite member
â”‚   â”‚           â”‚   â”‚       â””â”€â”€ [memberId]/
â”‚   â”‚           â”‚   â”‚           â””â”€â”€ route.ts     # DELETE: Remove member
â”‚   â”‚           â”‚   â””â”€â”€ invitations/
â”‚   â”‚           â”‚       â””â”€â”€ accept/
â”‚   â”‚           â”‚           â””â”€â”€ route.ts         # POST: Accept invitation
â”‚   â”‚           â”œâ”€â”€ invoices/
â”‚   â”‚           â”‚   â”œâ”€â”€ route.ts      # GET: List invoices
â”‚   â”‚           â”‚   â””â”€â”€ [invoiceId]/
â”‚   â”‚           â”‚       â””â”€â”€ route.ts  # GET: Invoice details
â”‚   â”‚           â””â”€â”€ webhook/
â”‚   â”‚               â””â”€â”€ route.ts      # POST: Stripe webhook handler
â”‚
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ billing/                      # Billing business logic (NEW)
â”‚   â”‚   â”œâ”€â”€ stripe.ts                 # Stripe client singleton
â”‚   â”‚   â”œâ”€â”€ subscription.ts           # Subscription CRUD
â”‚   â”‚   â”œâ”€â”€ quota.ts                  # Usage tracking/enforcement
â”‚   â”‚   â”œâ”€â”€ team.ts                   # Team management
â”‚   â”‚   â”œâ”€â”€ webhook.ts                # Webhook processing
â”‚   â”‚   â”œâ”€â”€ proration.ts              # Proration calculations
â”‚   â”‚   â”œâ”€â”€ dunning.ts                # Payment recovery
â”‚   â”‚   â””â”€â”€ types.ts                  # Billing TypeScript types
â”‚   â”œâ”€â”€ email/
â”‚   â”‚   â””â”€â”€ templates/                # Email templates (NEW)
â”‚   â”‚       â”œâ”€â”€ subscription-created.tsx
â”‚   â”‚       â”œâ”€â”€ trial-ending.tsx
â”‚   â”‚       â”œâ”€â”€ payment-failed.tsx
â”‚   â”‚       â”œâ”€â”€ team-invitation.tsx
â”‚   â”‚       â””â”€â”€ invoice.tsx
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ errors.ts                 # Extend with billing error codes
â”‚
â””â”€â”€ types/
    â””â”€â”€ billing.ts                    # Billing TypeScript interfaces (NEW)

# Database Migrations

supabase/migrations/
â””â”€â”€ 20251105_subscription_billing.sql  # All 11 tables + triggers (NEW)
```

**Structure Decision**: Web application structure with Next.js App Router. Billing logic isolated in `src/lib/billing/` for reusability across API routes and webhooks. All billing endpoints under `/api/v1/billing/` following existing API versioning pattern.

## Complexity Tracking

> No constitutional violations - all requirements align with project standards.

| Requirement | Status | Notes |
|-------------|--------|-------|
| Library-First Approach | âœ… Compliant | Billing logic extracted to `src/lib/billing/` |
| Performance Monitoring | âœ… Compliant | Datadog tracking for all endpoints |
| API-First Design | âœ… Compliant | All billing operations via REST endpoints |

## Phase 0: Research & Technical Decisions âœ… COMPLETE

### Research Completed

See [research.md](./research.md) for comprehensive findings.

**Key Decisions Made**:

1. **Trial Implementation**: 14-day with payment method required
   - **Rationale**: 60%+ conversion rate vs 30% for no-payment-required trials
   - **Stripe Mode**: `payment_behavior: 'default_incomplete'` with `trial_period_days: 14`

2. **Team Billing**: App-level 3-seat minimum enforcement
   - **Rationale**: Better UX than Stripe metadata validation
   - **Implementation**: Validation in `POST /teams` endpoint before Stripe API call

3. **Proration**: Automatic via Stripe (`create_prorations: 'create_prorations'`)
   - **Rationale**: Stripe handles all edge cases transparently
   - **Verification**: Preview API before actual charge

4. **Tax Calculation**: Stripe Tax enabled
   - **Rationale**: Automatic compliance, reduces legal risk
   - **Setup**: Configure tax collection in Stripe Dashboard

5. **Webhook Idempotency**: Database-backed with unique constraint on `stripe_events.id`
   - **Rationale**: Prevents duplicate processing (25%+ events are retries)
   - **Implementation**: Insert event ID before processing, catch conflict errors

6. **Dunning Strategy**: Smart Retries + 4-stage email campaign
   - **Rationale**: Maximizes recovery (70% success rate vs 40% for manual retries)
   - **Schedule**: Day 0, 3, 7, 14 with escalating email urgency

7. **Checkout Mode**: Hosted Stripe Checkout
   - **Rationale**: PCI compliant, no custom payment forms needed
   - **Integration**: Server-side session creation, client-side redirect

## Phase 1: Design & Contracts âœ… COMPLETE

### Data Model âœ…

See [data-model.md](./data-model.md) for complete schema.

**Core Tables** (11 total):
1. `subscriptions` - User subscriptions with plan and status
2. `stripe_customers` - Stripe Customer mapping
3. `payment_methods` - Tokenized payment methods
4. `teams` - Team subscriptions
5. `team_members` - Team membership and invitations
6. `usage_records` - Quota tracking per billing period
7. `invoices` - Transaction history
8. `credit_balances` - Account credits from downgrades
9. `subscription_events` - Audit log
10. `dunning_attempts` - Payment recovery tracking
11. `stripe_events` - Webhook idempotency

**Triggers**:
- Auto-update `updated_at` timestamps
- Sync `teams.filled_seats` on member changes
- Update `profiles.plan` on subscription status change

**Functions**:
- `check_upload_quota(user_id)` - Real-time quota validation

### API Contracts âœ…

See [contracts/billing-api.yaml](./contracts/billing-api.yaml) for OpenAPI 3.1 specification.

**Endpoints** (14 total):

| Method | Path | Purpose |
|--------|------|---------|
| POST | `/create-checkout` | Create Stripe Checkout session |
| POST | `/create-portal` | Create Customer Portal session |
| GET | `/subscription` | Get current subscription |
| POST | `/subscription/cancel` | Cancel subscription |
| POST | `/subscription/reactivate` | Reactivate subscription |
| GET | `/usage` | Get usage and quotas |
| POST | `/usage/check` | Check upload quota |
| POST | `/teams` | Create team subscription |
| GET | `/teams/{teamId}` | Get team details |
| PATCH | `/teams/{teamId}` | Update team (seats, billing) |
| POST | `/teams/{teamId}/members` | Invite team member |
| DELETE | `/teams/{teamId}/members/{memberId}` | Remove team member |
| POST | `/teams/invitations/accept` | Accept team invitation |
| GET | `/invoices` | List invoices (paginated) |
| GET | `/invoices/{invoiceId}` | Get invoice details |
| POST | `/webhook` | Stripe webhook handler |

**Webhook Events Handled**:
- `customer.subscription.created` - Initialize subscription
- `customer.subscription.updated` - Update status
- `customer.subscription.deleted` - Mark canceled
- `customer.subscription.trial_will_end` - Send reminder
- `invoice.payment_succeeded` - Record payment
- `invoice.payment_failed` - Trigger dunning
- `invoice.finalized` - Generate invoice record

### Quickstart Guide âœ…

See [quickstart.md](./quickstart.md) for developer setup instructions.

**Setup Time**: ~30 minutes
**Prerequisites**: Stripe account, Supabase instance, Node.js 20+

## Phase 2: Implementation Order (Generated by /speckit.tasks)

Implementation tasks defined in `tasks.md`.

**Recommended Order**:

### Week 1: Core Infrastructure
1. Database migration (11 tables + triggers)
2. Stripe client library wrapper
3. Webhook endpoint with idempotency
4. Basic subscription CRUD operations

### Week 2: Checkout & Trials
1. Checkout session creation
2. Customer Portal integration
3. Trial-to-paid conversion handling

### Week 3: Quota & Usage
1. Usage tracking system
2. Quota enforcement in upload endpoints

### Week 4: Team Billing
1. Team creation and subscription
2. Member invitation system
3. Seat management with proration

### Week 5: Dunning & Recovery
1. Payment failure detection
2. Smart Retries configuration
3. Dunning email campaign
4. Grace period enforcement

### Week 6: Invoice & Analytics
1. Invoice generation and storage
2. Email delivery system
3. Basic revenue analytics

### Week 7: Polish & Deployment
1. Error handling refinement
2. Performance optimization
3. Production deployment

## Phase 3: Agent Context Update

Run after Phase 1 completion:

```bash
.specify/scripts/bash/update-agent-context.sh claude
```

This updates `.specify/memory/claude.md` with:
- Stripe integration patterns
- Billing endpoint conventions
- Database schema for subscriptions
- Webhook processing best practices

## Success Criteria Validation

After implementation, verify against spec [Success Criteria](./spec.md#success-criteria):

- [ ] **SC-001**: Pro upgrade completes in <2min with access in <60s
- [ ] **SC-002**: 95% payment success rate, 30%+ dunning recovery
- [ ] **SC-003**: Invoice generation in <5min for 99% of transactions
- [ ] **SC-004**: 100% quota enforcement accuracy
- [ ] **SC-005**: 100% proration calculation accuracy
- [ ] **SC-006**: 1,000 concurrent operations without degradation
- [ ] **SC-007**: 100% invoice retrieval success rate
- [ ] **SC-008**: Team management in <30s with billing adjustment
- [ ] **SC-009**: Cancellation in <1min, email in <5min
- [ ] **SC-010**: Analytics API <2s response time
- [ ] **SC-011**: Webhook processing <10s, zero duplicates
- [ ] **SC-012**: Dunning emails <1hr after retry, 40%+ engagement
- [ ] **SC-013**: 99.9% billing API uptime
- [ ] **SC-014**: 15%+ conversion improvement
- [ ] **SC-015**: 60% reduction in billing support tickets

## Dependencies & Integration Points

### Existing Systems
- **Authentication** (`src/app/api/v1/auth/*`): User authentication for billing endpoints
- **Upload System** (`src/app/api/v1/upload/*`): Quota enforcement integration
- **Email Service** (`src/lib/email/sendgrid.ts`): Billing notification delivery
- **Error Handling** (`src/lib/api/errors.ts`): Extend with billing error codes

### External Services
- **Stripe**: Payment processing, subscription management, tax calculation
- **SendGrid**: Email delivery for billing notifications
- **Supabase**: Database, authentication, RLS policies
- **Vercel**: Deployment platform, Edge Runtime for API routes

### New Integrations Required
1. **Quota Middleware**: Add quota check to upload endpoint before processing
2. **Subscription Middleware**: Validate active subscription for premium features
3. **Profile Extension**: Add `plan` field to user profile responses
4. **Analytics Integration**: Track billing metrics for conversion analysis

## Deployment Strategy

### Staging (First)
1. Deploy with Stripe test mode
2. Verify webhook processing
3. Validate quota enforcement
4. Validate email delivery

### Production (After Staging Validation)
1. Switch to Stripe live mode keys
2. Configure production webhook endpoint
3. Enable Stripe Tax
4. Test with real payment (refund immediately)
5. Monitor for 24 hours before announcing

### Rollback Plan
1. Webhook endpoint: Disable in Stripe Dashboard
2. API routes: Revert deployment in Vercel
3. Database: No rollback needed (tables remain, no data corruption)
4. Subscription status: Use Stripe Dashboard to manage manually if needed

## Monitoring & Alerts

### Metrics to Track
- **Conversion Rate**: Free â†’ Pro, Free â†’ Team
- **Trial Conversion**: Trial â†’ Paid (target: 60%+)
- **Churn Rate**: Monthly cancellations
- **Payment Success Rate**: Valid payment attempts (target: 95%+)
- **Dunning Recovery**: Failed â†’ Recovered (target: 30%+)
- **Webhook Latency**: Processing time (target: <2s p95)
- **Quota Accuracy**: Blocks vs Allows (target: 100% accuracy)

### Alerts
- âš ï¸ Payment success rate drops below 90%
- âš ï¸ Webhook processing failures exceed 1% of events
- âš ï¸ Invoice generation failures
- âš ï¸ Quota enforcement errors (false negatives/positives)
- ðŸ”´ Stripe API errors (rate limiting, outages)
- ðŸ”´ Database connection failures
- ðŸ”´ Email delivery failures >5%

### Dashboards
1. **Revenue Dashboard**: MRR, ARR, new subscriptions, churn
2. **Health Dashboard**: Payment success, webhook latency, API uptime
3. **Conversion Dashboard**: Trial conversions, upgrade prompts, quota warnings
4. **Support Dashboard**: Failed payments, dunning status, cancellation reasons

## Security Considerations

### PCI Compliance âœ…
- No card data stored in database
- Stripe Checkout handles payment collection
- Stripe Elements for custom forms (future)
- HTTPS enforced for all endpoints

### Webhook Security âœ…
- Signature verification with `stripe.webhooks.constructEvent()`
- Timestamp validation (prevent replay attacks)
- Idempotency (database-backed event deduplication)
- Rate limiting on webhook endpoint (100 req/min max)

### RLS Policies âœ…
- Users can only view own subscriptions
- Team members can only view their team
- Invoices accessible only to owner
- Service role for webhook processing

### Secrets Management âœ…
- Stripe keys in environment variables (never committed)
- Webhook secrets rotated quarterly
- Service role keys for Supabase (restricted to billing operations)

## Post-Launch Iterations

### Phase 2 (Future)
- Self-service plan changes (upgrade/downgrade without portal)
- Multiple payment methods per customer
- Payment method auto-failover
- Subscription pausing (pause/resume)

### Phase 3 (Future)
- Annual plan discount variations (20%, 25%)
- Custom enterprise plans
- Billing portal customization
- Multi-currency support

### Phase 4 (Future)
- Revenue recognition reporting
- Cohort analysis
- Retention forecasting
- Churn prediction ML model

## Conclusion

This implementation plan provides a complete blueprint for building a production-grade subscription billing system using Stripe and Supabase. All research is complete, data model is finalized, and API contracts are defined. The next step is `/speckit.tasks` to generate the detailed implementation task list.

**Estimated Timeline**: 7 weeks to production-ready billing system
**Team Size**: 1-2 developers
**Risk Level**: Medium (Stripe abstracts payment complexity, primary risk is webhook reliability)
**Success Probability**: High (proven patterns, comprehensive research, clear requirements)
